Menu="Dashboard"
Cond="version_compare(parse_ini_file('/etc/unraid-version')['version'],'6.12.0-beta6', '<')"
Icon="ups"
---
<!--
Corsair PSU Statistics - AX1600i Support Patch
Patch by bngoold for the Unraid community
-->
<style type="text/css">
<?php
    $corsairpsu_cfg = parse_plugin_cfg("corsairpsu",true);
    if ($corsairpsu_cfg["TYPE"] == "cpsumoncli" || $corsairpsu_cfg["TYPE"] == "ax1600i") {
        echo '.corsair-uptime-rm { display:none; }';
        echo '.corsair-temp-rm { display:none; }';
    } else {    
        echo '.corsair-uptime-rm td { padding-bottom: 20px !important;}';
        echo '.corsair-temp-ax { display:none; }';
    }
?>
    #dash_corsairpsu_settings i, #dash_corsairpsu_toggle {margin-top:0px;}  
    .dash_corsairpsu_header {padding-top: 20px} 
    .dash_corsairpsu_section {
        line-height:1.4em !important;
        margin-left:-4px !important;
    }
    .dash_corsairpsu_table_header {text-decoration:underline;}
</style>
<table id="db-box1" class="dash_corsairpsu dashboard box1" style="display:none">
    <thead sort="965" class="sortable">
        <tr>
            <td></td>
            <td class="next dash_corsairpsu_header" colspan="3">
                <i class="icon-ups"></i>
                <div class="section dash_corsairpsu_section">Power Supply
                    <br>
                    <span class="corsair-vendor"></span> <span class="corsair-product"></span> (<span class="corsair-capacity"></span>W)
                    <span id="util">Utilization: <span class="corsair-load"></span>% (<span class="corsair-watts"></span>W)</span>
                    </span>
                    <br>
                </div>
                <i class="fa fa-fw chevron mt0" id="dash_corsairpsu_toggle" onclick="toggleChevron('dash_corsairpsu_toggle',0)"></i>
                <a href="/Settings/CorsairPSUSettings" id="dash_corsairpsu_settings" title="Go to Corsair PSU settings"><i class="fa fa-fw fa-cog chevron mt0"></i></a>
            </td>
            <td></td>
        </tr>
    </thead>
    <tbody class="dash_corsairpsu_toggle sortable" sort="965">
        <tr>
            <td></td>
            <td><span class="header dash_corsairpsu_table_header">12V</span></td>
            <td><span class="header dash_corsairpsu_table_header">5V</span></td>
            <td><span class="header dash_corsairpsu_table_header">3.3V</span></td>
            <td></td>
        </tr>
        <tr>
            <td></td>
            <td><span class="corsair-12v_load"></span>% (<span class="corsair-12v_watts"></span>W<span class="corsair-12v_amps"></span>)</td>
            <td><span class="corsair-5v_load"></span>% (<span class="corsair-5v_watts"></span>W<span class="corsair-5v_amps"></span>)</td>
            <td><span class="corsair-3v_load"></span>% (<span class="corsair-3v_watts"></span>W<span class="corsair-3v_amps"></span>)</td>
            <td></td>
        </tr>
        <tr><td colspan="5"></td></tr><tr><td colspan="5"></td></tr>
        <tr class="corsair-temp-rm">
            <td></td>
            <td>Temperature / Fan</td>
            <td><span class="corsair-temp1"></span> / <span class="corsair-temp2"></span> °C</td>
            <td><span class="corsair-fan_rpm"></span> RPM</td>
            <td></td>
        </tr>
        <tr class="corsair-temp-ax">
            <td></td>
            <td>Temp1 / Temp2</td>
            <td><span class="corsair-temp1"></span> / <span class="corsair-temp2"></span> °C</td>
            <td>Fan: <span class="corsair-fan_display"></span></td>
            <td></td>
        </tr>

        <tr class="corsair-efficiency-ax">
            <td></td>
            <td>Efficiency / Supply</td>
            <td><span class="corsair-efficiency"></span>%</td>
            <td><span class="corsair-input_voltage"></span>V (<span class="corsair-input_power"></span>W<span class="corsair-input_amps"></span>)</td>
            <td></td>
        </tr>
    </tbody>
</table>
<script>
const corsairpsu_status = () => {
    $.getJSON("/plugins/corsairpsu/status.php", (data) => {
        if (data) {
         $.each(data, function (key, data) {
             $(".corsair-" + key).html(data);
         });
         
         // Format amperage displays with comma separator
         if (data['12v_current']) {
             $(".corsair-12v_amps").html(", " + data['12v_current'] + "A");
         }
         if (data['5v_current']) {
             $(".corsair-5v_amps").html(", " + data['5v_current'] + "A");
         }
         if (data['3v_current']) {
             $(".corsair-3v_amps").html(", " + data['3v_current'] + "A");
         }
         if (data['input_current']) {
             $(".corsair-input_amps").html(", " + data['input_current'] + "A");
         }
         
         // Display fan with percentage and consistent formatting
         if (data['fan_rpm'] == 0) {
             $(".corsair-fan_display").html("0% (Passive)");
         } else {
             $(".corsair-fan_display").html(data['fan_percentage'] + "% (" + data['fan_rpm'] + " RPM)");
         }
        }
    });
};
$(corsairpsu_status);
if (<?=$corsairpsu_cfg['UIREFRESH'];?>) {
    setInterval(corsairpsu_status, <?=max(abs($display['refresh']), $corsairpsu_cfg['UIREFRESHINT']);?>);
}

$(function() {
  // append data from the table into the correct one
  $("#db-box1").append($(".dash_corsairpsu").html());
  
  // reload toggle to get the correct state
  toggleView('dash_corsairpsu_toggle',true);
  
  // reload sorting to get the stored data (cookie)
  sortTable($('#db-box1'),$.cookie('db-box1'));
});
</script>
